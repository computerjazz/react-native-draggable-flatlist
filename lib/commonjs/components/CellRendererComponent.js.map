{"version":3,"names":["CellRendererComponent","props","item","index","onLayout","children","rest","viewRef","useRef","useRefs","cellDataRef","propsRef","containerRef","useAnimatedValues","horizontalAnim","scrollOffset","useDraggableFlatListContext","activeKey","keyExtractor","horizontal","layoutAnimationDisabled","key","offset","useSharedValue","size","heldTanslate","translate","useCellTranslate","cellOffset","cellSize","cellIndex","isActive","animStyle","useAnimatedStyle","value","isWeb","t","transform","translateX","translateY","updateCellMeasurements","useStableCallback","onSuccess","x","y","w","h","current","set","measurements","onFail","debug","console","log","containerNode","viewNode","nodeHandle","measureLayout","onCellLayout","e","useEffect","requestAnimationFrame","baseStyle","useMemo","elevation","zIndex","flexDirection","itemEnteringAnimation","itemExitingAnimation","itemLayoutAnimation","enableLayoutAnimationExperimental","tag","findNodeHandle","runOnUI","_layoutDisabled","config","global","LayoutAnimationRepository","configs","stashConfig","stashedConfig","getStashedConfig","removeConfig","registerConfig","undefined","style","styles","zeroTranslate","typedMemo","StyleSheet","create","RNDFLLayoutAnimationConfigStash"],"sources":["CellRendererComponent.tsx"],"sourcesContent":["import React, { useEffect, useMemo, useRef } from \"react\";\nimport {\n  findNodeHandle,\n  LayoutChangeEvent,\n  MeasureLayoutOnSuccessCallback,\n  StyleProp,\n  StyleSheet,\n  ViewStyle,\n} from \"react-native\";\nimport Animated, {\n  runOnUI,\n  useAnimatedStyle,\n  useSharedValue,\n} from \"react-native-reanimated\";\nimport { useDraggableFlatListContext } from \"../context/draggableFlatListContext\";\nimport { isWeb } from \"../constants\";\nimport { useCellTranslate } from \"../hooks/useCellTranslate\";\nimport { typedMemo } from \"../utils\";\nimport { useRefs } from \"../context/refContext\";\nimport { useAnimatedValues } from \"../context/animatedValueContext\";\nimport CellProvider from \"../context/cellContext\";\nimport { useStableCallback } from \"../hooks/useStableCallback\";\n\ntype Props<T> = {\n  item: T;\n  index: number;\n  children: React.ReactNode;\n  onLayout?: (e: LayoutChangeEvent) => void;\n  style?: StyleProp<ViewStyle>;\n};\n\nfunction CellRendererComponent<T>(props: Props<T>) {\n  const { item, index, onLayout, children, ...rest } = props;\n\n  const viewRef = useRef<Animated.View>(null);\n  const { cellDataRef, propsRef, containerRef } = useRefs<T>();\n\n  const { horizontalAnim, scrollOffset } = useAnimatedValues();\n  const {\n    activeKey,\n    keyExtractor,\n    horizontal,\n    layoutAnimationDisabled,\n  } = useDraggableFlatListContext<T>();\n\n  const key = keyExtractor(item, index);\n  const offset = useSharedValue(-1);\n  const size = useSharedValue(-1);\n  const heldTanslate = useSharedValue(0);\n\n  const translate = useCellTranslate({\n    cellOffset: offset,\n    cellSize: size,\n    cellIndex: index,\n  });\n\n  const isActive = activeKey === key;\n\n  const animStyle = useAnimatedStyle(() => {\n    // When activeKey becomes null at the end of a drag and the list reorders,\n    // the animated style may apply before the next paint, causing a flicker.\n    // Solution is to hold over the last animated value until the next onLayout.\n    // (Not required in web)\n    if (translate.value && !isWeb) {\n      heldTanslate.value = translate.value;\n    }\n    const t = activeKey ? translate.value : heldTanslate.value;\n    return {\n      transform: [horizontalAnim.value ? { translateX: t } : { translateY: t }],\n    };\n  }, [translate, activeKey]);\n\n  const updateCellMeasurements = useStableCallback(() => {\n    const onSuccess: MeasureLayoutOnSuccessCallback = (x, y, w, h) => {\n      if (isWeb && horizontal) x += scrollOffset.value;\n      const cellOffset = horizontal ? x : y;\n      const cellSize = horizontal ? w : h;\n      cellDataRef.current.set(key, {\n        measurements: { size: cellSize, offset: cellOffset },\n      });\n\n      size.value = cellSize;\n      offset.value = cellOffset;\n    };\n\n    const onFail = () => {\n      if (propsRef.current?.debug) {\n        console.log(`## on measure fail, index: ${index}`);\n      }\n    };\n\n    const containerNode = containerRef.current;\n    const viewNode = viewRef.current;\n    const nodeHandle = containerNode;\n\n    if (viewNode && nodeHandle) {\n      //@ts-ignore\n      viewNode.measureLayout(nodeHandle, onSuccess, onFail);\n    }\n  });\n\n  const onCellLayout = useStableCallback((e?: LayoutChangeEvent) => {\n    heldTanslate.value = 0;\n    updateCellMeasurements();\n    if (onLayout && e) onLayout(e);\n  });\n\n  useEffect(() => {\n    if (isWeb) {\n      // onLayout isn't called on web when the cell index changes, so we manually re-measure\n      requestAnimationFrame(() => {\n        onCellLayout();\n      });\n    }\n  }, [index, onCellLayout]);\n\n  const baseStyle = useMemo(() => {\n    return {\n      elevation: isActive ? 1 : 0,\n      zIndex: isActive ? 999 : 0,\n      flexDirection: horizontal ? (\"row\" as const) : (\"column\" as const),\n    };\n  }, [isActive, horizontal]);\n\n  const {\n    itemEnteringAnimation,\n    itemExitingAnimation,\n    itemLayoutAnimation,\n  } = propsRef.current;\n\n  useEffect(() => {\n    // NOTE: Keep an eye on reanimated LayoutAnimation refactor:\n    // https://github.com/software-mansion/react-native-reanimated/pull/3332/files\n    // We might have to change the way we register/unregister LayouAnimations:\n    // - get native module: https://github.com/software-mansion/react-native-reanimated/blob/cf59766460d05eb30357913455318d8a95909468/src/reanimated2/NativeReanimated/NativeReanimated.ts#L18\n    // - register layout animation for tag: https://github.com/software-mansion/react-native-reanimated/blob/cf59766460d05eb30357913455318d8a95909468/src/reanimated2/NativeReanimated/NativeReanimated.ts#L99\n    if (!propsRef.current.enableLayoutAnimationExperimental) return;\n    const tag = findNodeHandle(viewRef.current);\n\n    runOnUI((t: number | null, _layoutDisabled) => {\n      \"worklet\";\n      if (!t) return;\n      const config = global.LayoutAnimationRepository.configs[t];\n      if (config) stashConfig(t, config);\n      const stashedConfig = getStashedConfig(t);\n      if (_layoutDisabled) {\n        global.LayoutAnimationRepository.removeConfig(t);\n      } else if (stashedConfig) {\n        global.LayoutAnimationRepository.registerConfig(t, stashedConfig);\n      }\n    })(tag, layoutAnimationDisabled);\n  }, [layoutAnimationDisabled]);\n\n  return (\n    <Animated.View\n      {...rest}\n      ref={viewRef}\n      onLayout={onCellLayout}\n      entering={itemEnteringAnimation}\n      exiting={itemExitingAnimation}\n      layout={\n        propsRef.current.enableLayoutAnimationExperimental\n          ? itemLayoutAnimation\n          : undefined\n      }\n      style={[\n        props.style,\n        baseStyle,\n        activeKey ? animStyle : styles.zeroTranslate,\n      ]}\n      pointerEvents={activeKey ? \"none\" : \"auto\"}\n    >\n      <CellProvider isActive={isActive}>{children}</CellProvider>\n    </Animated.View>\n  );\n}\n\nexport default typedMemo(CellRendererComponent);\n\nconst styles = StyleSheet.create({\n  zeroTranslate: {\n    transform: [{ translateX: 0 }, { translateY: 0 }],\n  },\n});\n\ndeclare global {\n  namespace NodeJS {\n    interface Global {\n      RNDFLLayoutAnimationConfigStash: Record<string, unknown>;\n    }\n  }\n}\n\nrunOnUI(() => {\n  \"worklet\";\n  global.RNDFLLayoutAnimationConfigStash = {};\n})();\n\nfunction stashConfig(tag: number, config: unknown) {\n  \"worklet\";\n  if (!global.RNDFLLayoutAnimationConfigStash)\n    global.RNDFLLayoutAnimationConfigStash = {};\n  global.RNDFLLayoutAnimationConfigStash[tag] = config;\n}\n\nfunction getStashedConfig(tag: number) {\n  \"worklet\";\n  if (!global.RNDFLLayoutAnimationConfigStash) return null;\n  return global.RNDFLLayoutAnimationConfigStash[tag] as Record<string, unknown>;\n}\n"],"mappings":"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"}